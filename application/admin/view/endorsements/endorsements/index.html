<div class="row">
    <div class="col-xs-12 col-sm-12">
        <form style="" class="exportForm" name="addQuotationForm">
        <div class="widget-box">
            <div class="widget-header">
                <h5 class="widget-title">批单查询</h5>
            </div>
            <div class="widget-body">
                <div class="form-inline form-group col-xs-12" style="margin-top:20px;">
                    <div class=" search-item-div col-xs-3">
                        <label for="p_temporary_id" class="text-center search-item-label">批单暂存单号:</label>
                        <input type="text" class="form-control" id="p_temporary_id" name="p_temporary_id" style="width:100%" value="{:input('param.p_temporary_id')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="endorsements_id" class="text-center search-item-label">批单号:</label>
                        <input type="text" class="form-control" id="endorsements_id" name="endorsements_id" style="width:100%" value="{:input('param.endorsements_id')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="documents_id" class="text-center search-item-label">单证号:</label>
                        <input type="text" class="form-control" id="documents_id" name="documents_id" style="width:100%" value="{:input('param.documents_id')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="overall_id" class="text-center search-item-label">统筹单号:</label>
                        <input type="text" class="form-control" id="overall_id" name="overall_id" style="width:100%" value="{:input('param.overall_id')}">
                    </div>
                </div>

                <div class="form-inline form-group col-xs-12" style="margin-top:20px;">
                    <div class=" search-item-div col-xs-3">
                        <label for="plate" class="text-center search-item-label">车牌号:</label>
                        <input type="text" class="form-control" id="plate" name="plate" style="width:100%" value="{:input('param.plate')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="frame" class="text-center search-item-label">车架号:</label>
                        <input type="text" class="form-control" id="frame" name="frame" style="width:100%" value="{:input('param.frame')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="participate_name" class="text-center search-item-label">参统人:</label>
                        <input type="text" class="form-control" id="participate_name" name="participate_name" style="width:100%" value="{:input('param.participate_name')}">
                    </div>
                </div>

                <div class="form-inline form-group col-xs-12" style="margin-top:20px;">
                    <div class=" search-item-div col-xs-3">
                        <label for="coordinated_name" class="text-center search-item-label">被参统人:</label>
                        <input type="text" class="form-control" id="coordinated_name" name="coordinated_name" style="width:100%" value="{:input('param.coordinated_name')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="endorsements_time_start" class="text-center search-item-label">批改日期起期:</label>
                        <input type="text" class="form-control" id="endorsements_time_start" name="endorsements_time_start" readonly style="width:100%" value="{:input('param.endorsements_time_start')}">
                    </div>
                    <div class="search-item-div col-xs-3">
                        <label for="endorsements_time_end" class="text-center search-item-label">批改日期止期:</label>
                        <input type="text" class="form-control" id="endorsements_time_end" name="endorsements_time_end" readonly style="width:100%" value="{:input('param.endorsements_time_end')}">
                    </div>
                </div>

                <div class=" search-item-div col-xs-3 col-lg-offset-6">
                    <button class="layui-btn layui-btn-radius layui-btn-normal" id="search">查询</button>
                    <button class="layui-btn layui-btn-radius layui-btn-normal" value="reset" type="reset">重置</button>
                </div>
                </div>
        </div>
        </form>
    </div>
    <div class="col-xs-12 col-sm-12">
        <div class="widget-box">
            <div class="widget-header">
                <h5 class="widget-title">统筹单列表</h5>
            </div>
            <div class="widget-body">
                <div class="clearfix">
                    <div class="pull-right tableTools-container"></div>
                </div>
                <table id="dynamic-table" class="table table-striped table-bordered table-hover center">
                    <thead>
                    <tr>
                        <th class="center"><input type="checkbox"></th>
                        <th class="center">批单暂存单号</th>
                        <th class="hidden-480 center">批单号</th>
                        <th class="hidden-480 center">统筹单号</th>
                        <th class="center">单证号</th>
                        <th class="center">车牌号</th>
                        <th class="center">车架号</th>
                        <th class="center">参统人</th>
                        <th class="hidden-480 center">被统筹人</th>
                        <th class="hidden-480 center">批改日期</th>
                        <th class="center">参统日期</th>
                        <th class="center">修改类型</th>
                        <th class="center">状态</th>
                        <th class="center">财务审核时间</th>
                        <th class="center">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    {volist name="$list" id="value"}
                    <tr data-documents="{$value.documents_id}" data-status="{$value.status}"  data-id="{$value.p_temporary_id}">
                        <td><input type="checkbox" name="endorsement_check" class="endorsement_check" value="{$value.p_temporary_id}"></td>
                        <td><a href="/admin/Endorsements/endorsements/view?p_temporary_id={$value.p_temporary_id}">{$value.p_temporary_id}</a> </td>
                        <td>{$value.endorsements_id}</td>
                        <td>{$value.overall_id}</td>
                        <td>{$value.documents_id}</td>
                        <td>{$value.plate}</td>
                        <td>{$value.frame}</td>
                        <td>{$value.participate_name}</td>
                        <td>{$value.coordinated_name}</td>
                        <td>{:date('Y-m-d',$value.endorsements_time)}</td>
                        <td>{:date('Y-m-d',$value.create_time)}</td>
                        <td>{$value.endorsements_typeStr}</td>
                        <td>{$value.statusStr}</td>
                        <td>{if $value.financial_review_time neq 0}{:date('Y-m-d H:i:s',$value.financial_review_time)}{/if}</td>
                        <td>
                            <div class="hidden-sm hidden-xs action-buttons">
                                <a class="green" href="/admin/Endorsements/fullorder/editEndorsements?p_temporary_id={$value.p_temporary_id}">
                                    <i class="ace-icon fa fa-pencil bigger-130"></i>
                                </a>

                                <a class="red delEndorsements" href="">
                                    <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                </a>
                            </div>
                            <div class="hidden-md hidden-lg">
                                <div class="inline pos-rel">
                                    <button class="btn btn-minier btn-yellow dropdown-toggle" data-toggle="dropdown" data-position="auto">
                                        <i class="ace-icon fa fa-caret-down icon-only bigger-120"></i>
                                    </button>

                                    <ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">
                                        <li>
                                            <a class="green" href="/admin/Endorsements/fullorder/p_temporary_id?id={$value.p_temporary_id}">
                                                <i class="ace-icon fa fa-pencil bigger-130"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="red delEndorsements" href="#">
                                                <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {/volist}
                    </tbody>
                </table>
                <div style="margin-left:40%" class="second">
                    <button class="layui-btn layui-btn-radius layui-btn-normal cancelPass">取消通过</button>
                    <button class="layui-btn layui-btn-radius layui-btn-normal addDocuments">批单打印</button>
                    <button class="layui-btn layui-btn-radius layui-btn-normal overallPdf">电子统筹单打印</button>
                    <button class="layui-btn layui-btn-radius layui-btn-normal export">导出</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 打印modal开始-->
<div class="modal fade" id="documents_edit_modal" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">单证号修改</h4>
            </div>
            <div class="modal-body">
                <span>打印单号:</span>
                <input type="text" id="documents_id_add" style="width:20%;margin-left:1rem" value="">
                <input type="hidden" id="overall_documents" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="addDocuments">提交</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!--打印modal结束-->
{include file="public/export" /}
<script>
    jQuery(function($) {
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#create_time_start' //交强起期
                , format: 'yyyy/MM/dd'
                , done: function (value, date, endDate) {
                    $("#create_time_start").val(value);
                }
            });
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#create_time_end' //交强起期
                , format: 'yyyy/MM/dd'
                , done: function (value, date, endDate) {
                    $("#create_time_end").val(value);
                }
            });
        });
        //生成统筹单跳转
        $(".overallPdf").on('click',function() {
            var total = 0;
            var value = '';
            var status = '';
            $(".endorsement_check").each(function() {
                if(this.checked){
                    total ++;
                    value = $(this).val();
                    status = $(this).parents("tr").attr("data-status");
                }
            })
            if(total > 1) {
                layer.msg("只能选择一项");
                return false;
            }else if(total == 0) {
                layer.msg("请选择一项");
                return false;
            }else{
                if(status != 4) {
                    layer.msg("审核未通过禁止生成统筹单");
                    return false;
                }
                window.location.href="/admin/Overall/overall/overallPdf?p_temporary_id="+value;
            }
            return false;
        })
        //打印
        $(".addDocuments").on('click',function() {
            var but = $(this);
            but.attr("disabled","disabled");;
            var total = 0;
            var documents_id = '';
            var p_temporary_id = '';
            $(".endorsement_check").each(function() {
                if(this.checked){
                    total ++;
                    documents_id = $(this).parents("tr").attr("data-documents");
                    p_temporary_id = $(this).val();
                }
            })
            if(documents_id != '') {
                layer.confirm('此单号已打印是否重新打印?', function(index){
                    layer.close(index);
                    $("#overall_documents").val(p_temporary_id);
                    $("#documents_id_add").val(documents_id);
                    $("#documents_edit_modal").modal();
                });
            }else{
                $("#overall_documents").val(p_temporary_id);
                $("#documents_id_add").val("");
                $("#documents_edit_modal").modal();
            }
            but.removeAttr("disabled");
        })
        //打印提交
        $("#addDocuments").on('click',function() {
            var documents_id = $("#documents_id_add").val()
            var but = $(this);
            but.attr("disabled","disabled");;
            var p_temporary_id = $("#overall_documents").val();
            $.ajax('/admin/ajax/Overall/overall/editDocuments',{
                dataType: 'json', // type of response data
                timeout: 500,     // timeout milliseconds
                method: "post",
                data: {documents_id:documents_id,related_id:p_temporary_id,issued_type:2},
                success: function (data,status,xhr) {   // success callback function
                    but.removeAttr("disabled");
                    if(data.code == 100000) {
                        layer.msg(data.msg);
                        setTimeout(function() {
                            location.reload();
                        },300);
                    }else{
                        layer.msg(data.msg);
                    }
                },
                error: function() {
                    but.removeAttr("disabled");
                    layer.msg("系统错误");
                }
            });
        })
        //取消通过
        $(".cancelPass").on('click',function () {
            var but = $(this);
            but.attr("disabled","disabled");;
            var total = 0;
            var status = '';
            var temporary_id = '';
            $(".endorsement_check").each(function() {
                if(this.checked){
                    total ++;
                    status = $(this).parents("tr").attr("data-status");
                    temporary_id = $(this).val();
                }
            })
            if(total > 1) {
                layer.msg("请仅选择一项");
                but.removeAttr("disabled");
                return false;
            }
            if(status != 4) {
                layer.msg("该批单不是审核通过状态");
                but.removeAttr("disabled");
                return false;
            }
            $.ajax('/admin/ajax/review/primary/review',{
                dataType: 'json', // type of response data
                timeout: 500,     // timeout milliseconds
                method: "post",
                data: {related_id:temporary_id,type:2,status:1,log_type:7},
                success: function (data,status,xhr) {   // success callback function
                    but.removeAttr("disabled");
                    if(data.code == 100000) {
                        layer.msg(data.msg);
                        setTimeout(function() {
                            window.location.href="/admin/Endorsements/endorsements/index";
                        },300);
                    }else{
                        layer.msg(data.msg);
                    }
                },
                error: function() {
                    but.removeAttr("disabled");
                    layer.msg("系统错误");
                }
            });
        })
        //删除
        $(".delEndorsements").on('click',function() {
            var endorsements = $(this).parents('tr').attr("data-id");
            var but = $(this);
            but.attr("disabled","disabled");
            layer.confirm('是否确认删除?', function(index){
                var id = but.parents('tr').attr("data-id");
                $.ajax('/admin/ajax/Endorsements/endorsements/delEndorsements',{
                    dataType: 'json', // type of response data
                    timeout: 500,     // timeout milliseconds
                    method: "post",
                    data: {id:endorsements},
                    success: function (data,status,xhr) {   // success callback function
                        but.removeAttr("disabled");
                        if(data.code == 100000) {
                            layer.msg(data.msg);
                            setTimeout(function() {
                                location.reload();
                            },300);
                        }else{
                            layer.msg(data.msg);
                        }
                    },
                    error: function() {
                        layer.msg("系统错误");
                    }
                });
                layer.close(index);
            });
            return false;
        })
    });
</script>
