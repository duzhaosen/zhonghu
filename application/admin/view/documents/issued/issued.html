<link rel="stylesheet" href="/static/ace1.4/assets/css/chosen.min.css">
<script src="/static/ace1.4/assets/js/chosen.jquery.min.js"></script>
<script  src="/static/ace1.4/assets/js/select-treeview.js"></script>
<div class="row">
    <div class="col-xs-12 col-sm-12">
        <div class="widget-box">
            <div class="widget-header">
                <h5 class="widget-title">单证下发</h5>
            </div>
            <div class="widget-body">
                <form action="" name="addIssuedForm">
                    <div class="form-inline form-group col-xs-11" style="margin-top:20px;">
                        <div class=" search-item-div col-xs-3">
                            <label for="issued_structure" class="text-center search-item-label">下发部门:</label>
                            <ul id="issued_structure" class="col-xs-6" style="padding:0px;width:100%"></ul>
                        </select>
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="issued_user" class="text-center search-item-label">下发工号:</label>
                            <select class="chosen-select form-control" id="issued_user" name="issued_user" style="width:100%" >
                                <option value="0">请选择下发工号</option>
                                {volist name="users" id="value"}
                                <option value="{$value.id}" data-manager="{$value.manager_id}">{$value.all_name}</option>
                                {/volist}
                            </select>
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="issued_type" class="text-center search-item-label">单证类型:</label>
                            <select class="form-control" id="issued_type" name="issued_type" style="width:100%">
                                <option value="0">请选择单证类型</option>
                                {volist name="type" id="value" key="key"}
                                <option value="{$key-1}" {if input('param.type') eq $key-1} selected {/if}>{$value}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="form-inline form-group col-xs-11" style="margin-top:20px;">
                        <div class=" search-item-div col-xs-3">
                            <label for="issued_s_num" class="text-center search-item-label">起始号:</label>
                            <input type="text" class="form-control" id="issued_s_num" name="issued_s_num" style="width:100%" value="">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="issued_e_num" class="text-center search-item-label">截止号:</label>
                            <input type="text" class="form-control" id="issued_e_num" name="issued_e_num" style="width:100%">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="issued_total" class="text-center search-item-label">数量:</label>
                            <input type="text" class="form-control" id="issued_total" name="issued_total" style="width:100%" value="">
                        </div>
                        <div class="search-item-div col-xs-1">
                            <button class="layui-btn layui-btn-radius layui-btn-normal" id="issued" style="margin-top:2rem">下发</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-xs-12 col-sm-12">
        <div class="widget-box">
            <div class="widget-header">
                <h5 class="widget-title">下发查询</h5>
            </div>
            <div class="widget-body">
                <form action="" class="exportForm" name="searchIssued">
                    <div class="form-inline form-group col-xs-11" style="margin-top:20px;">
                        <div class=" search-item-div col-xs-3">
                            <label class="text-center search-item-label">批次号:</label>
                            <input type="text" class="form-control" name="issued_id" style="width:100%" value="{:input('param.issued_id')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label class="text-center search-item-label">单证号:</label>
                            <input type="text" class="form-control" name="documents_id" style="width:100%" value="{:input('param.documents_id')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label class="text-center search-item-label">下发部门:</label>
                            <ul id="issued_structure_search" class="col-xs-6" style="padding:0px;width:100%"></ul>
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label class="text-center search-item-label">下发工号:</label>
                            <select class="chosen-select form-control" name="issued_user" style="width:100%" >
                                <option value="0">请选择下发工号</option>
                                {volist name="users" id="value"}
                                <option value="{$value.id}" {if input('param.issued_user') eq $value.id} selected {/if}>{$value.all_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>


                    <div class="form-inline form-group col-xs-11" style="margin-top:20px;">
                        <div class=" search-item-div col-xs-3">
                            <label class="text-center search-item-label">下发日期:</label>
                            <input type="text" class="form-control" readonly name="issued_create_time" style="width:100%" value="{:input('param.issued_create_time')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label class="text-center search-item-label">操作人:</label>
                            <input type="text" class="form-control" name="issued_create_user" style="width:100%" value="{:input('param.issued_create_user')}">
                        </div>
                    </div>

                    <div class="form-inline form-group col-xs-11" style="margin-top:20px;">
                        <div class=" search-item-div col-xs-3 ">
                            <button class="layui-btn layui-btn-radius layui-btn-normal search">查询</button>
                            <button class="layui-btn layui-btn-radius layui-btn-normal export">导出</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-xs-12 col-sm-12">
        <div class="widget-box">
            <div class="widget-header">
                <h5 class="widget-title">统筹单列表</h5>
            </div>
            <div class="widget-body">
                <div class="clearfix">
                    <div class="pull-right tableTools-container"></div>
                </div>
                <table id="dynamic-table" class="table table-striped table-bordered table-hover center">
                    <thead>
                    <tr>
                        <th class="center">下发批次号</th>
                        <th class="hidden-480 center">入库批次号</th>
                        <th class="hidden-480 center">下发部门</th>
                        <th class="center">下发工号</th>
                        <th class="center">单证类型</th>
                        <th class="center">起始号</th>
                        <th class="center">截止号</th>
                        <th class="hidden-480 center">下发数量</th>
                        <th class="center">剩余量</th>
                        <th class="center">下发时间</th>
                        <th class="center">有效截止期</th>
                        <th class="center">操作人</th>
                        <th class="center">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    {volist name="list" id="value"}
                    <tr data-id="{$value.issued_id}">
                        <td>{$value.issued_id}</td>
                        <td>{$value.add_id}</td>
                        <td>{$value.issued_structureStr}</td>
                        <td>{$value.issued_userStr}</td>
                        <td>{$value.issued_typeStr}</td>
                        <td>{$value.issued_s_num}</td>
                        <td>{$value.issued_e_num}</td>
                        <td>{$value.issued_total}</td>
                        <td>{$value.issued_remaining}</td>
                        <td>{:date('Y-m-d H:i:s',$value.issued_create_time)}</td>
                        <td>{:date('Y-m-d H:i:s',$value.issued_end_time)}</td>
                        <td>{$value.issued_create_user}</td>
                        <td>
                            <div class="hidden-sm hidden-xs action-buttons">
                                <a class="red viewInfo" href="">
                                    <i class="ace-icon fa fa-check bigger-120"></i>
                                </a>
                                <a class="red delDocuments" href="">
                                    <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                </a>
                            </div>
                            <div class="hidden-md hidden-lg">
                                <div class="inline pos-rel">
                                    <button class="btn btn-minier btn-yellow dropdown-toggle" data-toggle="dropdown" data-position="auto">
                                        <i class="ace-icon fa fa-caret-down icon-only bigger-120"></i>
                                    </button>

                                    <ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">
                                        <li>
                                            <a class="red viewInfo" href="#">
                                                <i class="ace-icon fa fa-check bigger-130"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="red delDocuments" href="#">
                                                <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {/volist}
                    </tbody>
                </table>
                {$list->render()}
            </div>
        </div>
    </div>
</div>
<!--查询使用详情modal开始-->
<div class="modal fade" id="viewInfoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:50%">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">详情使用</h4>
            </div>
            <div class="modal-body">
                <table id="document_info" class="table table-striped table-bordered table-hover center">
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!--查询使用详情modal结束-->
{include file="public/export" /}
<script>
    const structure_data = {$structureList};
    const searchstructure_data = {$SearchstructureList};
    jQuery(function($) {
        layui.use('laydate', function() {
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#issued_create_time' //交强起期
                , format: 'yyyy-MM-dd'
                , done: function (value, date, endDate) {
                    $("#issued_create_time").val(value);
                }
            });
        });
        var options = {
            data: structure_data,
            id: "id",
            text: "text",
            nodes: "nodes",
            checked: "checked",
            name: "issued_structure",
        };
        /**
         * 提初始化树结构
         */
        $('#issued_structure').AddSelect(options);
        var options = {
            data: searchstructure_data,
            id: "id",
            text: "text",
            nodes: "nodes",
            checked: "checked",
            name: "issued_structure",
        };
        /**
         * 提初始化树结构
         */
        $('#issued_structure_search').AddSelect(options);
        $('.chosen-select').chosen({allow_single_deselect:true});
        //计算数量
        $("#issued_e_num").on('keyup',function() {
            var val = $(this).val();
            var s_num = $("#issued_s_num").val();
            var num = parseInt(val) - parseInt(s_num);
            $("#issued_total").val(num+1);
        })
        //下发
        $("#issued").on('click',function() {
            var but = $(this);
            but.attr("disabled","disabled");
            var form = $("form[name=addIssuedForm]").serializeArray();
            var url = '/admin/ajax/Documents/issued/issuedDocuments';
            var issued_structures = $("#issued_structure").GetSelect().split(',');
            var structure_length = issued_structures.length;
            if(structure_length > 1 && issued_structures[structure_length-1] == "") {
                replaceForm(form, 'issued_structure', issued_structures[structure_length-2]);
            }
            $.ajax(url, {
                dataType: 'json', // type of response data
                timeout: 500,     // timeout milliseconds
                method: "post",
                data: form,
                success: function (data, status, xhr) {   // success callback function
                    but.removeAttr("disabled");
                    if (data.code == 100000) {
                        layer.msg(data.msg);
                        setTimeout(function () {
                            location.reload();
                        }, 300);
                    } else {
                        layer.msg(data.msg);
                    }
                },
                error: function () {
                    but.removeAttr("disabled");
                    layer.msg("系统错误");
                }
            });
            return false;
        })
        //删除
        $(".delDocuments").on('click',function() {
            var documents = $(this).parents('tr').attr("data-id");
            var but = $(this);
            but.attr("disabled","disabled");
            layer.confirm('是否确认删除?', function(index){
                $.ajax('/admin/ajax/Documents/Issued/delIssued',{
                    dataType: 'json', // type of response data
                    timeout: 500,     // timeout milliseconds
                    method: "post",
                    data: {issued_id:documents},
                    success: function (data,status,xhr) {   // success callback function
                        but.removeAttr("disabled");
                        if(data.code == 100000) {
                            layer.msg(data.msg);
                            setTimeout(function() {
                                location.reload();
                            },300);
                        }else{
                            layer.msg(data.msg);
                        }
                    },
                    error: function() {
                        layer.msg("系统错误");
                    }
                });
                layer.close(index);
            });
            return false;
        })
        //查询
        $(".search").on('click',function() {
            var form = $("form[name=searchIssued]").serializeArray();
            var issued_structures = $("#issued_structure_search").GetSelect().split(',');
            var structure_length = issued_structures.length;
            if(structure_length > 1 && issued_structures[structure_length-1] == "") {
                replaceForm(form, 'issued_structure', issued_structures[structure_length-2]);
            }
            window.location.href="/admin/Documents/issued/issued?"+convertObj(form);
            return false;
        })
        //查看详情
        $(".viewInfo").on('click',function() {
            var related_id = $(this).parents('tr').attr("data-id");
            $.ajax('/admin/ajax/Documents/warehousing/getInfo',{
                dataType: 'json', // type of response data
                timeout: 500,     // timeout milliseconds
                method: "post",
                data: {related_id:related_id},
                success: function (data,status,xhr) {   // success callback function
                    if(data.code == 100000) {
                        $("#document_info").html(data.data);
                        $("#viewInfoModal").modal();
                    }else{
                        layer.msg(data.msg);
                    }
                },
                error: function() {
                    layer.msg("系统错误");
                }
            });
            return false;
        })
    })
    function convertObj(data) {
        var _result = [];
        for (var key = 0; key < data.length; key ++) {
            var value = data[key];
            if (value != undefined) {
                _result.push(value.name + '=' + value.value);
            }
        }
        return _result.join('&');
    }
</script>
