<link rel="stylesheet" href="/static/ace1.4/assets/css/chosen.min.css">
<script src="/static/ace1.4/assets/js/chosen.jquery.min.js"></script>
<div class="row">
    <form style="" class="exportForm" name="addQuotationForm">
        <div class="col-xs-12 col-sm-12">
            <div class="widget-box">
                <div class="widget-header">
                    <h5 class="widget-title">报价单查询</h5>
                </div>
                <div class="widget-body">
                    <div class="form-inline form-group col-xs-11" style="margin-top:20px;">
                        <div class=" search-item-div col-xs-3">
                            <label for="id" class="text-center search-item-label">报价单号:</label>
                            <input type="text" class="form-control" id="id" name="id" style="width:100%" value="{:input('param.id')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="car_name" class="text-center search-item-label">车主:</label>
                            <input type="text" class="form-control" id="car_name" name="car_name" style="width:100%" value="{:input('param.car_name')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="plate" class="text-center search-item-label">车牌号:</label>
                            <input type="text" class="form-control" id="plate" name="plate" style="width:100%" value="{:input('param.plate')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="frame" class="text-center search-item-label">车架号:</label>
                            <input type="text" class="form-control" id="frame" name="frame" style="width:100%" value="{:input('param.frame')}">
                        </div>
                    </div>

                    <div class="form-inline form-group col-xs-11">
                        <div class=" search-item-div col-xs-3">
                            <label for="manager" class="text-center search-item-label">经办人:</label>
                            <input type="text" class="form-control" id="manager" name="manager"  style="width:100%" value="{:input('param.manager')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="attribution_user" class="text-center search-item-label">归属人:</label>
                            <select class="chosen-select form-control" id="attribution_user" name="attribution_user" style="width:100%" data-placeholder="选择归属人">
                                <option value="0">请选择归属人</option>
                                {volist name="users" id="value"}
                                <option value="{$value.id}" {if input('param.attribution_user') eq $value.id} selected {/if} data-manager="{$value.manager_id}">{$value.all_name}</option>
                                {/volist}
                            </select>
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="create_user" class="text-center search-item-label">报价人:</label>
                            <input type="text" class="form-control" id="create_user" name="create_user" style="width:100%" value="{:input('param.create_user')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="remarks" class="text-center search-item-label">备注:</label>
                            <input type="text" class="form-control" id="remarks" name="remarks" style="width:100%" value="{:input('param.remarks')}">
                        </div>
                    </div>

                    <div class="form-inline form-group col-xs-11">
                        <div class=" search-item-div col-xs-3">
                            <label for="create_time_start" class="text-center search-item-label">录入日期起:</label>
                            <input type="text" class="form-control" id="create_time_start" readonly name="create_time_start"  style="width:100%" value="{:input('param.create_time_start')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="create_time_end" class="text-center search-item-label">录入日期止:</label>
                            <input type="text" class="form-control" id="create_time_end" readonly name="create_time_end" style="width:100%" value="{:input('param.create_time_end')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="start_time" class="text-center search-item-label">生效日期起:</label>
                            <input type="text" class="form-control" id="start_time" readonly name="start_time" style="width:100%" value="{:input('param.start_time')}">
                        </div>
                        <div class="search-item-div col-xs-3">
                            <label for="end_time" class="text-center search-item-label">生效日期止:</label>
                            <input type="text" class="form-control" id="end_time" readonly name="end_time" style="width:100%" value="{:input('param.end_time')}">
                        </div>
                    </div>
                    <div class="form-inline form-group col-xs-11">
                        <div class="">
                            <button class="layui-btn layui-btn-radius layui-btn-normal" id="search">查询</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="col-xs-12 col-sm-12">
        <div class="widget-box">
            <div class="widget-header">
                <h5 class="widget-title">报价单列表</h5>
            </div>
            <div class="widget-body">
                <div class="clearfix">
                    <div class="pull-right tableTools-container"></div>
                </div>
                <table id="dynamic-table" class="table table-striped table-bordered table-hover center">
                    <thead>
                    <tr>
                        <th class="center"><input type="checkbox"></th>
                        <th class="center">报价单号</th>
                        <th class="hidden-480 center">录入日期</th>
                        <th class="hidden-480 center">车主</th>
                        <th class="hidden-480 center">车牌号</th>
                        <th class="center">车架号</th>
                        <th class="center">车辆种类</th>
                        <th class="center">注册日期</th>
                        <th class="center">统筹起期</th>
                        <th class="hidden-480 center">无赔优系数</th>
                        <th class="hidden-480 center">折扣</th>
                        <th class="center">统筹费</th>
                        <th class="center">经办人</th>
                        <th class="center">归属人</th>
                        <th class="center">报价人</th>
                        <th class="center">备注</th>
                        <th class="center">操作</th>
                    </tr>
                    </thead>

                    <tbody>
                    {volist name="quotationList" id="value"}
                    <tr data-id="{$value.quotation_id}">
                        <td><input type="checkbox" class="quotation_check" value="{$value.quotation_id}"></td>
                        <td><a href="/admin/Quotation/quotation/view?id={$value.quotation_id}">{$value.quotation_id}</a></td>
                        <td class="hidden-480 col-xs-1">{if isset($value.create_time)}{:date('Y-m-d H:i:s',$value.create_time)}{/if}</td>
                        <td class="hidden-480">{$value.car_name}</td>
                        <td class="hidden-480">{$value.plate}</td>
                        <td>{$value.frame}</td>
                        <td>{$value.plate_typeStr}</td>
                        <td>{if isset($value.registered_time)}{:date('Y-m-d H:i:s',$value.registered_time)}{/if}</td>
                        <td>{if isset($value.start_time)}{:date('Y-m-d H:i:s',$value.start_time)}{/if}</td>
                        <td class="hidden-480">{$value.coefficient}</td>
                        <td class="hidden-480">{$value.discount}</td>
                        <td>{$value.total_planning}</td>
                        <td>{$value.managerStr}</td>
                        <td>{$value.attribution_userStr}</td>
                        <td>{$value.create_user}</td>
                        <td>{$value.remarks}</td>
                        <td>
                            <div class="hidden-sm hidden-xs action-buttons">
                                <a class="green" href="/admin/Quotation/quotation/edit?id={$value.quotation_id}">
                                    <i class="ace-icon fa fa-pencil bigger-130"></i>
                                </a>

                                <a class="red delQuotation" href="">
                                    <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                </a>
                                <a class="blue" href="/admin/Quotation/quotation/copy?id={$value.quotation_id}">
                                    <i class="ace-icon fa fa-copy bigger-110 bigger-130"></i>
                                </a>
                            </div>
                            <div class="hidden-md hidden-lg">
                                <div class="inline pos-rel">
                                    <button class="btn btn-minier btn-yellow dropdown-toggle" data-toggle="dropdown" data-position="auto">
                                        <i class="ace-icon fa fa-caret-down icon-only bigger-120"></i>
                                    </button>

                                    <ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">
                                        <li>
                                            <a class="green" href="/admin/Quotation/quotation/edit?id={$value.quotation_id}">
                                                <i class="ace-icon fa fa-pencil bigger-130"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="red delQuotation" href="#">
                                                <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="blue" href="/admin/Quotation/quotation/copy?id={$value.quotation_id}">
                                                <i class="ace-icon fa sort bigger-130"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {/volist}
                    </tbody>
                </table>
                <div style="margin-left:40%" class="second">
                    <button class="layui-btn layui-btn-radius layui-btn-normal overall">转出单</button>
                    <button class="layui-btn layui-btn-radius layui-btn-normal quotationPdf">报价单</button>
                    <button class="layui-btn layui-btn-radius layui-btn-normal export">导出</button>
                </div>
                {$quotationList->render()}
            </div>
        </div>
    </div>
</div>
{include file="public/export" /}
<script>
    $(function() {
        $('.chosen-select').chosen({allow_single_deselect:true});
        //初始化日期
        layui.use('laydate', function(){
            var laydate = layui.laydate;

            //执行一个laydate实例
            laydate.render({
                elem: '#create_time_start' //指定元素
                ,format: 'yyyy-MM-dd'
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#create_time_end' //指定元素
                ,format: 'yyyy-MM-dd'
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#start_time' //指定元素
                ,format: 'yyyy-MM-dd'
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#end_time' //指定元素
                ,format: 'yyyy-MM-dd'
            });
        });
        //转出单
        $(".overall").on('click',function () {
            var total = 0;
            var value = '';
            $(".quotation_check").each(function() {
                if(this.checked){
                    total ++;
                    value = $(this).val();
                }
            })
            if(total > 1) {
                layer.msg("只能选择一项");
            }else if(total == 0) {
                layer.msg("请选择一项");
            }else{
                window.location.href="/admin/Overall/overall/add?quotation_id="+value;
            }
            return false;
        })
        //生成报价单跳转
        $(".quotationPdf").on('click',function() {
            var total = 0;
            var value = '';
            $(".quotation_check").each(function() {
                if(this.checked){
                    total ++;
                    value = $(this).val();
                }
            })
            if(total > 1) {
                layer.msg("只能选择一项");
            }else if(total == 0) {
                layer.msg("请选择一项");
            }else{
                window.location.href="/admin/Quotation/quotation/quotationPdf?id="+value;
            }
            return false;
        })
        //删除报价单
        $(".delQuotation").click(function() {
            var quotation = $(this).parents('tr').attr("data-id");
            var but = $(this);
            but.attr("disabled","disabled");
            layer.confirm('是否确认删除?', function(index){
                var id = but.parents('tr').attr("data-id");
                $.ajax('/admin/ajax/quotation/delQuotation',{
                    dataType: 'json', // type of response data
                    timeout: 500,     // timeout milliseconds
                    method: "post",
                    data: {id:quotation},
                    success: function (data,status,xhr) {   // success callback function
                        but.removeAttr("disabled");
                        if(data.code == 100000) {
                            layer.msg(data.msg);
                            setTimeout(function() {
                                location.reload();
                            },300);
                        }else{
                            layer.msg(data.msg);
                        }
                    },
                    error: function() {
                        layer.msg("系统错误");
                    }
                });
                layer.close(index);
            });
            return false;
        })
    })
</script>
